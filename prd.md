# PRD: Mac Studio M3 Ultra 大模型实验平台

## 1. 产品概述
### 1.1 文档标题和版本
- PRD: Mac Studio M3 Ultra 大模型实验平台
- 版本: 1.0

### 1.2 产品摘要
本产品需求文档描述了一个基于Mac Studio M3 Ultra的大型语言模型实验平台的设计和实现方案。该平台旨在提供一个灵活、强大且易于管理的环境，用于探索、测试和评估最新的大型语言模型（包括671B级别的DeepSeek模型）、新兴应用范式（如Agents、MCP、A2A协议）及相关工具链。

平台设计重点关注环境隔离（使用Conda）、性能监控、多样化框架支持以及通过Tailscale实现的便捷远程访问。设备固定放置在办公室，主要通过MacBook远程连接工作，并支持偶尔的多用户访问需求。

## 2. 目标
### 2.1 业务目标
- 建立一个高性能、灵活的大模型实验平台，支持前沿AI研究和应用开发
- 提供一个稳定、可靠的环境，确保实验结果的一致性和可复现性
- 优化资源利用，最大化Apple Silicon M3 Ultra芯片的性能潜力
- 支持多种模型格式和框架，适应快速变化的AI技术生态
- 实现高效的远程工作流程，提升研究和开发效率

### 2.2 用户目标
- 能够轻松运行和测试各种规模的大型语言模型，包括超大规模模型（如671B DeepSeek）
- 在不同实验之间实现严格的环境隔离，避免依赖冲突
- 方便地监控系统资源使用情况，优化模型运行效率
- 能够从任何位置安全地远程访问实验平台
- 系统化地管理和追踪实验参数、指标和结果
- 高效地组织和管理多种模型文件，优化存储空间使用

### 2.3 非目标
- 不提供生产环境部署方案，仅专注于研究和实验
- 不支持大规模多用户并发访问，主要面向个人使用和有限的协作场景
- 不提供商业级别的高可用性保障
- 不针对非Apple Silicon架构优化
- 不提供完整的模型训练流程（主要关注推理、微调和应用开发）

## 3. 用户画像
### 3.1 关键用户类型
- 主要用户（平台所有者）
- 访客用户（偶尔访问测试的合作者）

### 3.2 基本画像细节
- **研究者**: 专注于大型语言模型研究的AI研究人员，需要灵活的环境来测试和评估各种模型和技术。
- **应用开发者**: 开发基于大型语言模型的应用的工程师，需要稳定的环境来构建和测试应用原型。
- **访客合作者**: 偶尔需要访问平台进行特定测试或演示的合作伙伴。

### 3.3 基于角色的访问
- **平台所有者**: 拥有完全访问权限，可以管理系统、安装软件、创建环境、运行任何实验。
- **访客用户**: 拥有受限访问权限，可以使用预先配置的环境运行特定实验，但不能修改系统配置或安装新软件。

## 4. 功能需求
- **环境隔离系统** (优先级: 高)
  - 使用Conda/Miniforge实现Python环境隔离
  - 为不同实验创建独立环境
  - 提供环境模板和自动化脚本
  - 可选的容器化支持（Docker/Podman）
  - 严格的环境文档化要求

- **多框架支持** (优先级: 高)
  - 支持Ollama快速部署和API访问
  - 支持Llama.cpp高效推理（特别是GGUF模型）
  - 支持Apple MLX原生框架
  - 支持PyTorch (MPS Backend)
  - 支持多种Agent框架（LangChain、LlamaIndex、AutoGen、CrewAI等）

- **模型管理系统** (优先级: 高)
  - 清晰的模型存储结构
  - 支持多种模型格式（GGUF、GPTQ、SafeTensors等）
  - 模型元数据管理
  - 量化工具支持
  - 优化存储空间使用（如符号链接）

- **资源监控系统** (优先级: 中)
  - 实时CPU/GPU/内存使用监控
  - 资源使用警报机制
  - 性能分析工具
  - 可视化监控仪表板

- **实验管理工具** (优先级: 中)
  - 实验参数和结果追踪
  - 实验版本控制
  - 可视化分析工具
  - 实验报告生成
  - 优先使用Weights & Biases，MLflow作为备选

- **远程访问系统** (优先级: 高)
  - 基于Tailscale的安全网络连接
  - SSH远程访问配置
  - 多设备支持
  - 连接故障排查机制

- **安全与备份** (优先级: 中)
  - 全盘加密
  - 定期系统更新
  - 自动备份重要数据
  - 访问控制机制
  - 定期维护计划

- **多用户支持** (优先级: 低)
  - 访客用户账户
  - 权限隔离
  - 预配置环境
  - 使用指南文档
  - API和Web界面分享机制

## 5. 用户体验
### 5.1. 入口点和首次用户流程
- 平台所有者通过Tailscale和SSH从MacBook远程连接到Mac Studio
- 首次连接时配置基本环境（Conda、监控工具、框架等）
- 创建初始实验环境和目录结构
- 设置模型存储系统和元数据管理

### 5.2. 核心体验
- **环境准备**: 用户为新实验创建专用Conda环境，安装所需依赖。
  - 使用预定义的环境模板或自动化脚本加速此过程。
- **模型获取与管理**: 用户下载或准备模型文件，放入适当的存储结构中。
  - 记录模型元数据，必要时进行量化处理。
- **实验执行**: 用户激活相应环境，运行实验代码，同时监控资源使用情况。
  - 使用asitop或htop实时监控系统资源，确保高效运行。
- **结果分析与管理**: 用户使用实验管理工具记录参数和结果，进行可视化分析。
  - 通过WandB或MLflow追踪实验全生命周期，确保可复现性。

### 5.3. 高级功能和边缘情况
- 运行超大规模模型（如671B DeepSeek）时的内存管理和优化
- 多用户同时访问时的资源分配和隔离
- 系统资源接近极限时的预警和自动保护机制
- 远程连接中断时的实验保护和恢复机制
- 存储空间不足时的自动清理和优化建议

### 5.4. UI/UX 亮点
- 资源监控仪表板，提供直观的系统状态可视化
- 实验管理界面，支持参数、结果的组织和比较
- 模型管理系统，支持元数据查询和筛选
- 自动化脚本库，简化常见操作
- 实验模板系统，加速新实验设置
- Vibe Coding工具（如Cursor）的rules文件，提供智能编码辅助

## 6. 叙述
李研是一位AI研究者，他需要一个强大而灵活的平台来探索最新的大型语言模型，包括超大规模的671B参数模型。他的Mac Studio M3 Ultra实验平台让他能够在办公室设置一个固定的高性能工作站，同时通过Tailscale从任何地点安全地远程访问。系统的环境隔离确保他的每个实验都不会相互干扰，而完善的监控和实验管理工具让他能够系统地追踪结果并优化性能，大大提高了他的研究效率和成果质量。

## 7. 成功指标
### 7.1. 以用户为中心的指标
- 实验设置时间减少50%（通过环境模板和自动化脚本）
- 远程访问成功率达到99%以上
- 实验环境冲突减少至接近零
- 用户能够成功运行各种规模的模型，包括超大规模模型
- 开发经验和最佳实践的文档化率达到95%以上

### 7.2. 业务指标
- 研究和开发周期缩短30%
- 实验可复现性提高至95%以上
- 资源利用率提高40%（通过更好的监控和优化）
- 成功支持至少5种不同的大模型框架和10种不同规模的模型

### 7.3. 技术指标
- 系统稳定性：平均无故障运行时间>30天
- 远程连接延迟<100ms
- 大模型（>70B参数）推理性能达到Apple Silicon理论性能的85%以上
- 存储空间利用效率提高50%（通过优化的存储结构和符号链接）

## 8. 技术考虑因素
### 8.1. 集成点
- Conda/Miniforge与各种Python框架的集成
- Tailscale与SSH的集成
- 监控工具与系统资源的集成
- 实验管理工具与版本控制系统的集成
- 量化工具与不同模型格式的集成

### 8.2. 数据存储和隐私
- 模型文件存储在本地和外接SSD，需要合理组织
- 实验数据可能存储在本地或云端（取决于选择的实验管理工具）
- 备份策略需考虑数据量大的特点
- 访客用户应只能访问指定数据
- 支持从多种渠道（Hugging Face、GitHub等）获取模型

### 8.3. 可扩展性和性能
- 系统应能随着模型规模增长而适应（通过量化和优化）
- 存储系统应支持扩展（通过外接存储）
- 性能优化应充分利用M3 Ultra的特性（如神经引擎）
- 内存使用需要精心管理，特别是对于超大模型
- 并发实验能力有限，需要合理调度

### 8.4. 潜在挑战
- Apple Silicon对某些AI框架的兼容性问题
- 超大模型（如671B）的内存和性能限制
- 远程访问的网络稳定性和安全性
- 多用户场景下的资源竞争
- 快速变化的AI生态对系统适应性的要求
- 严格文档管理的持续维护挑战

## 9. 里程碑和排序
### 9.1. 项目估算
- 中等：2-3周

### 9.2. 团队规模和构成
- 小型团队：总共1-2人
  - 1名主要实施者（平台所有者）
  - 可选的1名技术顾问（特定领域专家）

### 9.3. 建议阶段
- **阶段1**: 基础环境搭建（3-5天）
  - 安装操作系统和核心工具
  - 配置Conda环境管理系统
  - 安装监控工具
  - 设置Tailscale远程访问

- **阶段2**: 核心框架与模型管理（5-7天）
  - 安装和配置各种AI框架
  - 建立模型存储结构
  - 设置模型元数据管理系统
  - 测试基本模型运行

- **阶段3**: 实验工作流与高级功能（5-7天）
  - 配置实验管理工具
  - 创建自动化脚本库
  - 设置实验模板
  - 配置多用户支持
  - 实施安全与备份策略
  - 创建Vibe Coding工具rules文件

- **阶段4**: 测试与优化（3-5天）
  - 全面测试各种规模模型
  - 优化性能和资源使用
  - 测试远程访问和多用户场景
  - 文档完善和使用指南编写
  - 建立文档管理系统和知识库

## 10. 用户故事
### 10.1. 环境隔离与管理
- **ID**: US-001
- **描述**: 作为平台用户，我希望能够为每个实验创建独立的环境，以避免依赖冲突。
- **验收标准**:
  - 用户可以使用Conda轻松创建新环境
  - 环境之间的依赖完全隔离
  - 用户可以导出环境配置以便复现
  - 提供环境模板加速常见实验类型的设置

### 10.2. 运行大规模模型
- **ID**: US-002
- **描述**: 作为研究者，我希望能够运行超大规模模型（如671B DeepSeek），以进行前沿研究。
- **验收标准**:
  - 系统能够通过量化技术支持超大模型
  - 提供内存使用监控和优化建议
  - 模型加载和推理性能达到可接受水平
  - 提供不同量化级别的性能/质量权衡选项

### 10.3. 远程访问实验平台
- **ID**: US-003
- **描述**: 作为移动工作的用户，我希望能够从任何位置安全地访问实验平台。
- **验收标准**:
  - Tailscale配置成功，提供稳定的虚拟网络
  - SSH远程连接配置正确，支持密钥认证
  - 远程连接延迟低，体验流畅
  - 提供连接问题的故障排查指南

### 10.4. 模型管理与存储
- **ID**: US-004
- **描述**: 作为平台用户，我希望能够有效地管理和组织多种模型文件。
- **验收标准**:
  - 清晰的模型存储目录结构已实施
  - 支持模型元数据记录和查询
  - 存储空间使用优化（如通过符号链接）
  - 支持多种模型格式和量化版本

### 10.5. 资源监控与优化
- **ID**: US-005
- **描述**: 作为平台用户，我希望能够实时监控系统资源使用情况，以优化实验性能。
- **验收标准**:
  - asitop和htop工具正确安装和配置
  - 用户可以查看CPU、GPU、内存使用情况
  - 提供资源使用警报机制
  - 可选的资源监控仪表板可用

### 10.6. 实验管理与追踪
- **ID**: US-006
- **描述**: 作为研究者，我希望能够系统地管理和追踪实验参数、指标和结果。
- **验收标准**:
  - WandB或MLflow正确配置
  - 用户可以记录实验参数和结果
  - 支持实验比较和可视化
  - 实验数据可导出和共享

### 10.7. 多用户支持
- **ID**: US-007
- **描述**: 作为平台所有者，我希望能够安全地允许其他用户访问系统进行测试。
- **验收标准**:
  - 访客用户账户创建成功，权限受限
  - 为访客准备的预配置环境可用
  - 用户指南文档完整清晰
  - 访客活动可被监控和审计

### 10.8. 安全备份与恢复
- **ID**: US-008
- **描述**: 作为平台用户，我希望重要数据能够定期备份，以防意外丢失。
- **验收标准**:
  - 自动备份机制已配置
  - 备份包括关键配置和实验数据
  - 提供简单的数据恢复流程
  - 备份策略考虑了大文件（如模型）的特殊需求

### 10.9. 自动化工作流
- **ID**: US-009
- **描述**: 作为频繁进行实验的用户，我希望常见操作能够自动化，以提高效率。
- **验收标准**:
  - 自动化脚本库已创建
  - 脚本涵盖环境创建、模型下载与转换等常见操作
  - 脚本文档完整，使用方便
  - 用户可以轻松扩展脚本库
  - 脚本支持从多种渠道获取模型

### 10.10. 框架兼容性与测试
- **ID**: US-010
- **描述**: 作为多框架用户，我希望系统能够支持多种AI框架，并确保它们在Apple Silicon上正常工作。
- **验收标准**:
  - 所有列出的框架（Ollama、Llama.cpp、MLX、PyTorch等）安装成功
  - 每个框架的基本功能测试通过
  - 提供各框架在Apple Silicon上的优化建议
  - 框架间的互操作性问题已记录和解决

### 10.11. 文档管理系统
- **ID**: US-011
- **描述**: 作为平台用户，我希望有一个严谨详细的文档管理系统，以记录经验和最佳实践。
- **验收标准**:
  - 多层次文档结构已建立
  - 自动化文档生成机制已实施
  - 文档与代码版本控制同步
  - 实验记录标准化模板已创建
  - 知识库和最佳实践指南已建立

### 10.12. Vibe Coding工具支持
- **ID**: US-012
- **描述**: 作为使用Cursor等AI辅助编码工具的开发者，我希望有专门的rules文件来提高开发效率。
- **验收标准**:
  - Cursor rules文件已创建并包含项目特定指南
  - 编码标准、架构指南和最佳实践已文档化
  - 针对不同任务的特定规则集已定义
  - 自动化检查与提示机制已实施
  - rules文件与文档管理系统集成
